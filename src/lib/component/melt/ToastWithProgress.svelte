<script>
    import { onMount } from 'svelte'
    import { writable } from 'svelte/store'
    import { createProgress, melt } from '@melt-ui/svelte'
    import { fly } from 'svelte/transition'

    /**
     * @typedef {{
     *      title: String,
     *      description: String,
     *      color: String
     * }} ToastData
     */

    /** @type {import('@melt-ui/svelte').ToastsElements} */
    export let elements
    $: ({ content, title, description, close } = elements)

    /** @type {ToastData} */
    export let toast
    $: ({ data, id, getPercentage } = toast)

    const percentage = writable(0)

    const {
        elements: { root: progress },
        options: { max }
    } = createProgress({
        max: 100,
        value: percentage
    })

    onMount(() => {
        /** @type {Number} */
        let frame
        const updatePercentage = () => {
            percentage.set(getPercentage())
            frame = requestAnimationFrame(updatePercentage)
        }
        frame = requestAnimationFrame(updatePercentage)

        return () => cancelAnimationFrame(frame)
    })
</script>

<div
    use:melt={$content(id)}
    in:fly={{ duration: 150, x: '100%' }}
    out:fly={{ duration: 150, x: '100%' }}
    class="relative rounded-lg bg-neutral-800 text-white shadow-md">
    <div use:melt={$progress} class="absolute left-5 top-2 h-1 w-[10%] overflow-hidden rounded-full bg-black/40">
    <div
      class="h-full w-full bg-magnum-500"
      style={`transform: translateX(-${
        100 - (100 * ($percentage ?? 0)) / ($max ?? 1)
      }%)`}/>
    </div>
 
    <div class="relative flex w-[24rem] max-w-[calc(100vw-2rem)] items-center justify-between gap-4 p-5 pt-6">
        <div>
            <h3 use:melt={$title(id)} class="flex items-center gap-2 font-semibold">
                {data.title}
                <span class="rounded-full square-1.5 {data.color}" />
            </h3>
            <div use:melt={$description(id)}>
                {data.description}
            </div>
        </div>
        <button
            use:melt={$close(id)}
            class="absolute right-4 top-4 grid place-items-center rounded-full text-magnum-500 square-6 hover:bg-magnum-900/50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
</div>